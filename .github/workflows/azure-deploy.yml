name: Build and Deploy to Azure Container Apps

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest
    
    env:
      # !!! REPLACE THESE PLACEHOLDER VALUES with your actual resource names !!!
      RESOURCE_GROUP_NAME: "smartparking-rg"
      CONTAINER_REGISTRY_NAME: "smartparkingacr"
      CONTAINER_APP_NAME: "smartparking-app"
      KEY_VAULT_NAME: "smartparking-keyvault"

    steps:
      - name: 'Checkout GitHub Action'
        uses: actions/checkout@v3

      - name: 'Login to Azure'
        uses: azure/login@v1
        with:
          # This uses the AZURE_CREDENTIALS secret you will create in GitHub
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: 'Login to Azure Container Registry (ACR)'
        run: |
          az acr login --name ${{ env.CONTAINER_REGISTRY_NAME }}

      - name: 'Build and Push Docker Image'
        run: |
          docker build . -t ${{ env.CONTAINER_REGISTRY_NAME }}.azurecr.io/smartparking:${{ github.sha }}
          docker push ${{ env.CONTAINER_REGISTRY_NAME }}.azurecr.io/smartparking:${{ github.sha }}

      - name: 'Deploy to Azure Container Apps'
        uses: azure/container-apps-deploy-action@v1
        with:
          appName: ${{ env.CONTAINER_APP_NAME }}
          resourceGroup: ${{ env.RESOURCE_GROUP_NAME }}
          imageToDeploy: ${{ env.CONTAINER_REGISTRY_NAME }}.azurecr.io/smartparking:${{ github.sha }}
          environmentVariables: 'KEY_VAULT_NAME=${{ env.KEY_VAULT_NAME }}'
